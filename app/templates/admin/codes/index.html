{% extends "base.html" %}

{% block title %}å…‘æ¢ç ç®¡ç† - GPT Team ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h2>å…‘æ¢ç ç®¡ç†</h2>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">ğŸ«</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">å…‘æ¢ç æ€»æ•°</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.unused }}</div>
            <div class="stat-label">æœªä½¿ç”¨</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.used }}</div>
            <div class="stat-label">å·²ä½¿ç”¨</div>
        </div>
    </div>
    <div class="stat-card stat-danger">
        <div class="stat-icon">â°</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.expired }}</div>
            <div class="stat-label">å·²è¿‡æœŸ</div>
        </div>
    </div>
</div>

<!-- æ“ä½œæ  -->
<div class="content-section">
    <div class="section-header">
        <div class="header-group">
            <div class="filter-tabs">
                <button onclick="filterByStatus('all')" class="filter-tab active" id="filter-all">å…¨éƒ¨</button>
                <button onclick="filterByStatus('unused')" class="filter-tab" id="filter-unused">æœªä½¿ç”¨</button>
                <button onclick="filterByStatus('used')" class="filter-tab" id="filter-used">å·²ä½¿ç”¨</button>
                <button onclick="filterByStatus('expired')" class="filter-tab" id="filter-expired">å·²è¿‡æœŸ</button>
            </div>

            <form action="/admin/codes" method="get" class="search-form">
                <div class="input-group-clean">
                    <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="æœç´¢å…‘æ¢ç ..."
                        style="width: 180px;">
                    {% if search %}
                    <a href="/admin/codes" title="æ¸…é™¤æœç´¢">
                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="header-actions">
            <div class="dropdown-wrapper">
                <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('columnToggleDropdown')">
                    <i data-lucide="columns" style="width: 16px; height: 16px;"></i> åˆ—è®¾ç½®
                </button>
                <div id="columnToggleDropdown" class="dropdown-menu">
                    <!-- Column checkboxes will be generated here -->
                </div>
            </div>
            <button onclick="showModal('generateCodeModal')" class="btn btn-primary">
                <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> ç”Ÿæˆå…‘æ¢ç 
            </button>
            <button onclick="exportCodes()" class="btn btn-secondary">
                <i data-lucide="download" style="width: 16px; height: 16px;"></i> å¯¼å‡º
            </button>
        </div>
    </div>
</div>

<!-- å…‘æ¢ç åˆ—è¡¨ -->
<div class="content-section">
    {% if codes %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"
                            style="width: auto; margin: 0;">
                    </th>
                    <th>å…‘æ¢ç </th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>è¿‡æœŸæ—¶é—´</th>
                    <th>ä½¿ç”¨è€…é‚®ç®±</th>
                    <th>ä½¿ç”¨æ—¶é—´</th>
                    <th>è´¨ä¿</th>
                    <th>è´¨ä¿æ—¶é•¿</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="codesTableBody">
                {% for code in codes %}
                <tr data-status="{{ code.status }}">
                    <td>
                        <input type="checkbox" class="code-checkbox" value="{{ code.code }}"
                            onchange="updateSelectionCount()" style="width: auto; margin: 0;">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="ticket" style="width: 14px; height: 14px; color: var(--text-muted);"></i>
                            <code>{{ code.code }}</code>
                        </div>
                    </td>
                    <td>
                        {% if code.status == 'unused' %}
                        <span class="status-badge status-active">æœªä½¿ç”¨</span>
                        {% elif code.status == 'used' %}
                        <span class="status-badge status-full">å·²ä½¿ç”¨</span>
                        {% elif code.status == 'warranty_active' %}
                        <span class="status-badge status-info">è´¨ä¿ä¸­</span>
                        {% elif code.status == 'expired' %}
                        <span class="status-badge status-error">å·²è¿‡æœŸ</span>
                        {% endif %}
                    </td>
                    <td>{{ code.created_at }}</td>
                    <td>{{ code.expires_at if code.expires_at else 'æ°¸ä¹…æœ‰æ•ˆ' }}</td>
                    <td>{{ code.used_by_email if code.used_by_email else '-' }}</td>
                    <td>{{ code.used_at if code.used_at else '-' }}</td>
                    <td>
                        {% if code.has_warranty %}
                        <span class="status-badge status-info">æ˜¯</span>
                        {% else %}
                        <span class="status-badge" style="background: #f3f4f6; color: #6b7280;">å¦</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if code.has_warranty %}
                        <span style="font-size: 0.875rem;">{{ code.warranty_days }} å¤©</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        <div class="action-buttons" style="justify-content: flex-end;">
                            <button onclick="copyCode('{{ code.code }}')"
                                class="btn btn-sm btn-icon btn-minimal btn-secondary" title="å¤åˆ¶">
                                <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button
                                onclick="editCode('{{ code.code }}', {{ 'true' if code.has_warranty else 'false' }}, {{ code.warranty_days or 30 }})"
                                class="btn btn-sm btn-icon btn-minimal btn-info" title="ç¼–è¾‘">
                                <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
                            </button>
                            {% if code.status == 'unused' %}
                            <button onclick="deleteCode('{{ code.code }}')"
                                class="btn btn-sm btn-icon btn-minimal btn-danger" title="åˆ é™¤">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ  -->
    <div id="bulkActionBar" class="bulk-action-bar" style="display: none;">
        <div class="bulk-info">
            å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªå…‘æ¢ç 
        </div>
        <div class="bulk-actions">
            <button onclick="showBulkEditModal()" class="btn btn-primary">
                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i> æ‰¹é‡ä¿®æ”¹è´¨ä¿
            </button>
            <button onclick="bulkDeleteCodes()" class="btn btn-danger">
                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i> æ‰¹é‡åˆ é™¤
            </button>
            <button onclick="deselectAll()" class="btn btn-secondary">å–æ¶ˆå…¨é€‰</button>
        </div>
    </div>

    <!-- åˆ†é¡µ -->
    <!-- åˆ†é¡µ -->
    {% if pagination %}
    <div class="pagination">
        <div class="per-page-selector">
            æ¯é¡µ
            <select class="per-page-select" onchange="changePerPage(this.value)">
                <option value="20" {% if pagination.per_page==20 %}selected{% endif %}>20</option>
                <option value="50" {% if pagination.per_page==50 %}selected{% endif %}>50</option>
                <option value="100" {% if pagination.per_page==100 %}selected{% endif %}>100</option>
            </select>
        </div>

        {% if pagination.total_pages > 1 %}
        {% set search_param = '&search=' + search|urlencode if search else '' %}
        {% set per_page_param = '&per_page=' + pagination.per_page|string if pagination.per_page != 50 else '' %}
        {% set base_query = search_param + per_page_param %}

        <div class="pagination-controls">
            <!-- é¦–é¡µ -->
            <a href="?page=1{{ base_query }}"
                class="btn btn-sm btn-secondary {% if pagination.current_page == 1 %}disabled{% endif %}" title="é¦–é¡µ">
                <i data-lucide="chevrons-left" style="width: 14px; height: 14px;"></i>
            </a>

            <!-- ä¸Šä¸€é¡µ -->
            {% if pagination.current_page > 1 %}
            <a href="?page={{ pagination.current_page - 1 }}{{ base_query }}" class="btn btn-sm btn-secondary"
                title="ä¸Šä¸€é¡µ">
                <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
            </a>
            {% else %}
            <button class="btn btn-sm btn-secondary" disabled>
                <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
            </button>
            {% endif %}

            <!-- é¡µç  -->
            <div class="pagination-numbers">
                {% set start_page = pagination.current_page - 2 %}
                {% set end_page = pagination.current_page + 2 %}

                {% if start_page < 1 %} {% set end_page=end_page + (1 - start_page) %} {% set start_page=1 %} {% endif
                    %} {% if end_page> pagination.total_pages %}
                    {% set start_page = start_page - (end_page - pagination.total_pages) %}
                    {% set end_page = pagination.total_pages %}
                    {% if start_page < 1 %} {% set start_page=1 %} {% endif %} {% endif %} {% if start_page> 1 %}
                        <a href="?page=1{{ base_query }}" class="page-number">1</a>
                        {% if start_page > 2 %}
                        <span class="page-dots">...</span>
                        {% endif %}
                        {% endif %}

                        {% for p in range(start_page, end_page + 1) %}
                        <a href="?page={{ p }}{{ base_query }}"
                            class="page-number {% if p == pagination.current_page %}active{% endif %}">{{ p }}</a>
                        {% endfor %}

                        {% if end_page < pagination.total_pages %} {% if end_page < pagination.total_pages - 1 %} <span
                            class="page-dots">...</span>
                            {% endif %}
                            <a href="?page={{ pagination.total_pages }}{{ base_query }}" class="page-number">{{
                                pagination.total_pages }}</a>
                            {% endif %}
            </div>

            <!-- ä¸‹ä¸€é¡µ -->
            {% if pagination.current_page < pagination.total_pages %} <a
                href="?page={{ pagination.current_page + 1 }}{{ base_query }}" class="btn btn-sm btn-secondary"
                title="ä¸‹ä¸€é¡µ">
                <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                </a>
                {% else %}
                <button class="btn btn-sm btn-secondary" disabled>
                    <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                </button>
                {% endif %}

                <!-- æœ«é¡µ -->
                <a href="?page={{ pagination.total_pages }}{{ base_query }}"
                    class="btn btn-sm btn-secondary {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}"
                    title="æœ«é¡µ">
                    <i data-lucide="chevrons-right" style="width: 14px; height: 14px;"></i>
                </a>
        </div>
        <span class="pagination-info" style="margin-left: 1rem;">å…± {{ pagination.total }} æ¡</span>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <i data-lucide="package-open" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.2;"></i>
        <p>æš‚æ— å…‘æ¢ç æ•°æ®</p>
        <button onclick="showModal('generateCodeModal')" class="btn btn-primary">ç«‹å³ç”Ÿæˆ</button>
    </div>
    {% endif %}
</div>

<!-- æ‰¹é‡ç¼–è¾‘å…‘æ¢ç æ¨¡æ€æ¡† -->
<div id="bulkEditCodeModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>æ‰¹é‡ä¿®æ”¹è´¨ä¿</h3>
            <button class="modal-close" onclick="hideModal('bulkEditCodeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                æ‚¨æ­£åœ¨æ‰¹é‡ä¿®æ”¹ <strong id="bulk-selected-count-display">0</strong> ä¸ªå…‘æ¢ç çš„è´¨ä¿ä¿¡æ¯ã€‚
            </div>
            <form id="bulkEditCodeForm" onsubmit="handleBulkEditCode(event)">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 1rem;">
                        <input type="checkbox" id="bulk-edit-has-warranty" name="hasWarranty"
                            style="width: auto; margin: 0;"
                            onchange="toggleWarrantyDays(this, 'bulk-edit-warranty-days-group')">
                        <span>è´¨ä¿å…‘æ¢ç  (å¯é‡å¤ä½¿ç”¨)</span>
                    </label>
                </div>
                <div class="form-group" id="bulk-edit-warranty-days-group" style="display: none;">
                    <label>è´¨ä¿æ—¶é•¿ (å¤©) *</label>
                    <input type="number" id="bulk-edit-warranty-days" name="warrantyDays" class="form-control"
                        value="30" min="1" max="3650">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å…‘æ¢ç æ¨¡æ€æ¡† -->
<div id="editCodeModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ç¼–è¾‘å…‘æ¢ç </h3>
            <button class="modal-close" onclick="hideModal('editCodeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editCodeForm" onsubmit="handleEditCode(event)">
                <input type="hidden" id="edit-code" name="code">
                <div class="form-group">
                    <label>å…‘æ¢ç </label>
                    <input type="text" id="edit-code-display" class="form-control" readonly
                        style="background: rgba(0,0,0,0.05);">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 1rem;">
                        <input type="checkbox" id="edit-has-warranty" name="hasWarranty" style="width: auto; margin: 0;"
                            onchange="toggleWarrantyDays(this, 'edit-warranty-days-group')">
                        <span>è´¨ä¿å…‘æ¢ç  (å¯é‡å¤ä½¿ç”¨)</span>
                    </label>
                </div>
                <div class="form-group" id="edit-warranty-days-group" style="display: none;">
                    <label>è´¨ä¿æ—¶é•¿ (å¤©) *</label>
                    <input type="number" id="edit-warranty-days" name="warrantyDays" class="form-control" value="30"
                        min="1" max="3650">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .bulk-action-bar {
        position: fixed;
        bottom: 5.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-secondary);
        color: var(--text-color);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 1000;
        border: 1px solid var(--border-color);
        animation: slideUp 0.3s ease-out;
        max-width: calc(100vw - 2rem);
        flex-wrap: wrap;
    }

    @keyframes slideUp {
        from {
            transform: translate(-50%, 100%);
            opacity: 0;
        }

        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    .bulk-info {
        font-weight: 500;
        color: var(--text-color);
    }

    .bulk-actions {
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .bulk-action-bar {
            left: 1rem;
            right: 1rem;
            bottom: 4.5rem;
            transform: none;
            justify-content: center;
        }

        .bulk-actions {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
    }

</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Init Column Toggler
        initColumnToggler('.data-table', 'codes_list_columns');
    });

    // Column Toggler Logic & Pagination
    function initColumnToggler(tableSelector, storageKey) {
        const table = document.querySelector(tableSelector);
        if (!table) return;

        const headers = table.querySelectorAll('thead th');
        const container = document.getElementById('columnToggleDropdown');
        if (!container) return;

        container.innerHTML = '<div class="dropdown-header">æ˜¾ç¤º/éšè—åˆ—</div>';

        // Load saved preferences
        const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');

        headers.forEach((th, index) => {
            const text = th.innerText.trim();
            if (!text || text === 'æ“ä½œ' || th.querySelector('input')) return; // Checkbox column or Action

            const isVisible = !saved.includes(index);
            if (!isVisible) {
                th.style.display = 'none';
                table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`).forEach(td => td.style.display = 'none');
            }

            const item = document.createElement('label');
            item.className = 'dropdown-item';
            item.innerHTML = `
        <input type="checkbox" ${isVisible ? 'checked' : ''}>
            <span>${text}</span>
            `;

            item.querySelector('input').addEventListener('change', (e) => {
                const checked = e.target.checked;
                // Toggle header
                th.style.display = checked ? '' : 'none';
                // Toggle cells
                table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`).forEach(td => td.style.display = checked ? '' : 'none');

                // Save to localStorage
                const currentSaved = JSON.parse(localStorage.getItem(storageKey) || '[]');
                if (checked) {
                    const idx = currentSaved.indexOf(index);
                    if (idx > -1) currentSaved.splice(idx, 1);
                } else {
                    if (!currentSaved.includes(index)) currentSaved.push(index);
                }
                localStorage.setItem(storageKey, JSON.stringify(currentSaved));
            });

            container.appendChild(item);
        });
    }

    function toggleDropdown(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.toggle('show');
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if (d.id !== id) d.classList.remove('show');
            });
        }
    }

    // Close dropdowns
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown-wrapper') && !e.target.closest('.dropdown-toggle')) {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
        }
    });

    function changePerPage(val) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', val);
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.code-checkbox');
        checkboxes.forEach(cb => {
            // åªé€‰æ‹©å½“å‰æ˜¾ç¤ºçš„è¡Œ
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = checkbox.checked;
            }
        });
        updateSelectionCount();
    }

    // å–æ¶ˆå…¨é€‰
    function deselectAll() {
        document.getElementById('selectAll').checked = false;
        toggleSelectAll(document.getElementById('selectAll'));
    }

    // æ›´æ–°é€‰æ‹©è®¡æ•°
    function updateSelectionCount() {
        const selected = document.querySelectorAll('.code-checkbox:checked');
        const count = selected.length;
        document.getElementById('selectedCount').innerText = count;

        const actionBar = document.getElementById('bulkActionBar');
        if (count > 0) {
            actionBar.style.display = 'flex';
        } else {
            actionBar.style.display = 'none';
        }
    }

    // æ˜¾ç¤ºæ‰¹é‡ç¼–è¾‘å¼¹çª—
    function showBulkEditModal() {
        const selected = document.querySelectorAll('.code-checkbox:checked');
        document.getElementById('bulk-selected-count-display').innerText = selected.length;
        showModal('bulkEditCodeModal');
    }

    // å¤„ç†æ‰¹é‡ç¼–è¾‘
    async function handleBulkEditCode(event) {
        event.preventDefault();
        const selected = document.querySelectorAll('.code-checkbox:checked');
        const codes = Array.from(selected).map(cb => cb.value);

        const has_warranty = document.getElementById('bulk-edit-has-warranty').checked;
        const warranty_days = parseInt(document.getElementById('bulk-edit-warranty-days').value) || 30;

        try {
            const response = await fetch('/admin/codes/bulk-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    codes: codes,
                    has_warranty: has_warranty,
                    warranty_days: has_warranty ? warranty_days : null
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('æ‰¹é‡æ›´æ–°æˆåŠŸ', 'success');
                hideModal('bulkEditCodeModal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(result.error || 'æ‰¹é‡æ›´æ–°å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error(error);
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // å½“å‰ç­›é€‰çŠ¶æ€
    let currentFilter = 'all';

    // æŒ‰çŠ¶æ€ç­›é€‰
    function filterByStatus(status) {
        currentFilter = status;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.filter-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`filter-${status}`).classList.add('active');

        // ç­›é€‰è¡¨æ ¼è¡Œ
        const rows = document.querySelectorAll('#codesTableBody tr');
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
                // å¦‚æœè¡Œè¢«éšè—ï¼Œå–æ¶ˆå…¶å¤é€‰æ¡†çš„é€‰æ‹©
                const cb = row.querySelector('.code-checkbox');
                if (cb) cb.checked = false;
            }
        });
        updateSelectionCount();
    }

    // åˆ é™¤å…‘æ¢ç 
    async function deleteCode(code) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å…‘æ¢ç  ${code} å—?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/codes/${encodeURIComponent(code)}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                // åˆ·æ–°é¡µé¢
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(result.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }


    // æ‰¹é‡åˆ é™¤å…‘æ¢ç 
    async function bulkDeleteCodes() {
        const selected = document.querySelectorAll('.code-checkbox:checked');
        const selectedCodes = Array.from(selected);
        const deletable = selectedCodes.filter(cb => cb.closest('tr')?.getAttribute('data-status') === 'unused');
        const skipped = selectedCodes.length - deletable.length;
        const codes = deletable.map(cb => cb.value);

        if (!codes.length) {
            showToast('ä»…æœªä½¿ç”¨å…‘æ¢ç å¯åˆ é™¤ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦æ‰¹é‡åˆ é™¤ ${codes.length} ä¸ªå…‘æ¢ç å—ï¼Ÿ${skipped > 0 ? `

å·²è‡ªåŠ¨è·³è¿‡ ${skipped} ä¸ªéæœªä½¿ç”¨å…‘æ¢ç ` : ''}`)) {
            return;
        }

        try {
            const response = await fetch('/admin/codes/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codes })
            });

            const result = await response.json();
            if (response.ok && result.success) {
                showToast(result.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast(result.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }


    // å¯¼å‡ºå…‘æ¢ç 
    async function exportCodes() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const search = urlParams.get('search') || '';
            const exportUrl = `/admin/codes/export${search ? '?search=' + encodeURIComponent(search) : ''}`;

            const response = await fetch(exportUrl);

            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `redemption_codes_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } else {
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // ç¼–è¾‘å…‘æ¢ç 
    function editCode(code, hasWarranty, warrantyDays) {
        document.getElementById('edit-code').value = code;
        document.getElementById('edit-code-display').value = code;

        const hasWarrantyCheckbox = document.getElementById('edit-has-warranty');
        hasWarrantyCheckbox.checked = hasWarranty;

        const warrantyDaysInput = document.getElementById('edit-warranty-days');
        warrantyDaysInput.value = warrantyDays || 30;

        // è§¦å‘æ˜¾ç¤º/éšè—
        toggleWarrantyDays(hasWarrantyCheckbox, 'edit-warranty-days-group');

        showModal('editCodeModal');
    }

    async function handleEditCode(event) {
        event.preventDefault();
        const code = document.getElementById('edit-code').value;
        const has_warranty = document.getElementById('edit-has-warranty').checked;
        const warranty_days = parseInt(document.getElementById('edit-warranty-days').value) || 30;

        try {
            const response = await fetch(`/admin/codes/${encodeURIComponent(code)}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    has_warranty,
                    warranty_days: has_warranty ? warranty_days : null
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('æ›´æ–°æˆåŠŸ', 'success');
                hideModal('editCodeModal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(result.error || 'æ›´æ–°å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }
</script>
{% endblock %}