{% extends "base.html" %}

{% block title %}控制台 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>控制台</h2>
</div>

<!-- 统计卡片 -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon"><i data-lucide="users"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.total_teams }}</div>
            <div class="stat-label">Team 总数</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon"><i data-lucide="check-circle"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.available_teams }}</div>
            <div class="stat-label">可用 Team</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon"><i data-lucide="ticket"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.total_codes }}</div>
            <div class="stat-label">兑换码总数</div>
        </div>
    </div>
    <div class="stat-card stat-warning">
        <div class="stat-icon"><i data-lucide="clipboard-list"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.used_codes }}</div>
            <div class="stat-label">已使用兑换码</div>
        </div>
    </div>

    <div class="stat-card stat-danger">
        <div class="stat-icon"><i data-lucide="mail-warning"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.pending_reminders }}</div>
            <div class="stat-label">待处理提醒</div>
        </div>
    </div>
</div>


<!-- Team 列表 -->
<div class="content-section">
    <div class="section-header">
        <h3>Team 列表</h3>
        <div class="header-group">
            <form action="/admin" method="get" class="search-form">
                <div class="input-group-clean">
                    <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="搜索邮箱/Account ID..."
                        style="width: 200px;">
                    {% if search %}
                    <a href="/admin" title="清除搜索">
                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
            <div class="dropdown-wrapper">
                <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('columnToggleDropdown')">
                    <i data-lucide="columns" style="width: 16px; height: 16px;"></i> 列设置
                </button>
                <div id="columnToggleDropdown" class="dropdown-menu">
                    <!-- Column checkboxes will be generated here -->
                </div>
            </div>
            <button onclick="showModal('importTeamModal')" class="btn btn-primary">
                <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> 导入 Team
            </button>
        </div>
    </div>

    {% if teams %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>邮箱</th>
                    <th>Account ID</th>
                    <th>Team 名称</th>
                    <th>成员数</th>
                    <th>订阅计划</th>
                    <th>到期时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr>
                    <td><span class="text-muted">{{ team.id }}</span></td>
                    <td>
                        {{ team.email }}
                        {% if team.account_role and team.account_role != 'account-owner' %}
                        <span class="role-hint" title="账号角色: {{ team.account_role }}">已降级</span>
                        {% endif %}
                    </td>
                    <td><span class="text-muted small">{{ team.account_id or '-' }}</span></td>
                    <td>{{ team.team_name or '-' }}</td>
                    <td>
                        <span class="member-count">
                            {{ team.current_members }}/{{ team.max_members }}
                        </span>
                    </td>
                    <td>{{ team.subscription_plan or '-' }}</td>
                    <td>
                        {% if team.expires_at %}
                        {{ team.expires_at|format_datetime }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ team.status }}">
                            {% if team.status == 'active' %}
                            可用
                            {% elif team.status == 'full' %}
                            已满
                            {% elif team.status == 'expired' %}
                            已过期
                            {% elif team.status == 'banned' %}
                            已封禁
                            {% elif team.status == 'error' %}
                            异常
                            {% else %}
                            未知
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-icon btn-minimal btn-info btn-view-members"
                                data-id="{{ team.id }}" data-email="{{ team.email }}" title="查看成员">
                                <i data-lucide="users" style="width: 16px; height: 16px;"></i>
                            </button>
                            <button class="btn btn-sm btn-icon btn-minimal btn-primary btn-edit-team"
                                data-id="{{ team.id }}" title="编辑">
                                <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
                            </button>
                            <button class="btn btn-sm btn-icon btn-minimal btn-secondary btn-refresh-team"
                                data-id="{{ team.id }}" title="刷新">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                            </button>
                            <button class="btn btn-sm btn-icon btn-minimal btn-danger btn-delete-team"
                                data-id="{{ team.id }}" data-email="{{ team.email }}" title="删除">
                                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    <!-- 分页 -->
    {% if pagination %}
    <div class="pagination">
        <div class="per-page-selector">
            每页
            <select class="per-page-select" onchange="changePerPage(this.value)">
                <option value="20" {% if pagination.per_page==20 %}selected{% endif %}>20</option>
                <option value="50" {% if pagination.per_page==50 %}selected{% endif %}>50</option>
                <option value="100" {% if pagination.per_page==100 %}selected{% endif %}>100</option>
            </select>
        </div>

        {% if pagination.total_pages > 1 %}
        {% set search_param = '&search=' + search|urlencode if search else '' %}
        {% set per_page_param = '&per_page=' + pagination.per_page|string if pagination.per_page != 20 else '' %}
        {% set base_query = search_param + per_page_param %}

        <div class="pagination-controls">
            <!-- 首页 -->
            <a href="?page=1{{ base_query }}"
                class="btn btn-sm btn-secondary {% if pagination.current_page == 1 %}disabled{% endif %}" title="首页">
                <i data-lucide="chevrons-left" style="width: 14px; height: 14px;"></i>
            </a>

            <!-- 上一页 -->
            {% if pagination.current_page > 1 %}
            <a href="?page={{ pagination.current_page - 1 }}{{ base_query }}" class="btn btn-sm btn-secondary"
                title="上一页">
                <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
            </a>
            {% else %}
            <button class="btn btn-sm btn-secondary" disabled>
                <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
            </button>
            {% endif %}

            <!-- 页码 -->
            <div class="pagination-numbers">
                {% set start_page = pagination.current_page - 2 %}
                {% set end_page = pagination.current_page + 2 %}

                {% if start_page < 1 %} {% set end_page=end_page + (1 - start_page) %} {% set start_page=1 %} {% endif
                    %} {% if end_page> pagination.total_pages %}
                    {% set start_page = start_page - (end_page - pagination.total_pages) %}
                    {% set end_page = pagination.total_pages %}
                    {% if start_page < 1 %} {% set start_page=1 %} {% endif %} {% endif %} {% if start_page> 1 %}
                        <a href="?page=1{{ base_query }}" class="page-number">1</a>
                        {% if start_page > 2 %}
                        <span class="page-dots">...</span>
                        {% endif %}
                        {% endif %}

                        {% for p in range(start_page, end_page + 1) %}
                        <a href="?page={{ p }}{{ base_query }}"
                            class="page-number {% if p == pagination.current_page %}active{% endif %}">{{ p }}</a>
                        {% endfor %}

                        {% if end_page < pagination.total_pages %} {% if end_page < pagination.total_pages - 1 %} <span
                            class="page-dots">...</span>
                            {% endif %}
                            <a href="?page={{ pagination.total_pages }}{{ base_query }}" class="page-number">{{
                                pagination.total_pages }}</a>
                            {% endif %}
            </div>

            <!-- 下一页 -->
            {% if pagination.current_page < pagination.total_pages %} <a
                href="?page={{ pagination.current_page + 1 }}{{ base_query }}" class="btn btn-sm btn-secondary"
                title="下一页">
                <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                </a>
                {% else %}
                <button class="btn btn-sm btn-secondary" disabled>
                    <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                </button>
                {% endif %}

                <!-- 末页 -->
                <a href="?page={{ pagination.total_pages }}{{ base_query }}"
                    class="btn btn-sm btn-secondary {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}"
                    title="末页">
                    <i data-lucide="chevrons-right" style="width: 14px; height: 14px;"></i>
                </a>
        </div>
        <span class="pagination-info" style="margin-left: 1rem;">共 {{ pagination.total }} 条</span>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <p>暂无 Team 数据</p>
        <button onclick="showModal('importTeamModal')" class="btn btn-primary">立即导入</button>
    </div>
    {% endif %}
</div>

<!-- 编辑 Team 模态框 -->
<div id="editTeamModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>编辑 Team 信息</h3>
            <button class="modal-close" onclick="hideModal('editTeamModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editTeamForm" onsubmit="handleEditTeam(event)">
                <input type="hidden" id="edit-team-id" name="teamId">
                <div class="form-group">
                    <label>邮箱 <span class="required">*</span></label>
                    <input type="email" id="edit-team-email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Access Token (AT) <span class="required">*</span></label>
                    <div class="input-group-btn">
                        <input type="text" id="edit-team-token" name="accessToken" class="form-control" required>
                        <button type="button" class="btn btn-secondary" onclick="refreshATInModal()"
                            title="立即从 ST/RT 刷新 AT">
                            <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Refresh Token (RT)</label>
                    <input type="text" id="edit-team-refresh-token" name="refreshToken" class="form-control">
                </div>
                <div class="form-group">
                    <label>Session Token</label>
                    <input type="text" id="edit-team-session-token" name="sessionToken" class="form-control">
                </div>
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="edit-team-client-id" name="clientId" class="form-control">
                </div>
                <div class="form-group">
                    <label>Account ID <span class="required">*</span></label>
                    <input type="text" id="edit-team-account-id" name="accountId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Team 名称</label>
                    <input type="text" id="edit-team-name" name="teamName" class="form-control">
                </div>
                <div class="form-group">
                    <label>账号角色</label>
                    <input type="text" id="edit-team-role" class="form-control" readonly title="检测到的账号角色">
                </div>
                <div class="form-group">
                    <label>最大成员数 <span class="required">*</span></label>
                    <input type="number" id="edit-team-max-members" name="maxMembers" class="form-control" min="1"
                        max="100" required>
                </div>
                <div class="form-group">
                    <label>状态 <span class="required">*</span></label>
                    <select id="edit-team-status" name="status" class="form-control" required>
                        <option value="active">活跃 (Active)</option>
                        <option value="full">已满 (Full)</option>
                        <option value="expired">已过期 (Expired)</option>
                        <option value="error">异常 (Error)</option>
                        <option value="banned">已封禁 (Banned)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">保存修改</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Init Column Toggler
        initColumnToggler('.data-table', 'team_list_columns');

        // 绑定查看成员按钮
        document.querySelectorAll('.btn-view-members').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const email = btn.getAttribute('data-email');
                viewMembers(id, email);
            });
        });

        // 绑定刷新按钮
        document.querySelectorAll('.btn-refresh-team').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                refreshTeam(id);
            });
        });

        // 绑定删除按钮
        document.querySelectorAll('.btn-delete-team').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const email = btn.getAttribute('data-email');
                deleteTeam(id, email);
            });
        });

        // 绑定编辑按钮
        document.querySelectorAll('.btn-edit-team').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                editTeam(id);
            });
        });
    });

    async function refreshTeam(teamId) {
        if (!confirm('确定要刷新此 Team 的信息吗?')) {
            return;
        }

        try {
            showToast('正在刷新...', 'info');
            const response = await fetch(`/api/teams/${teamId}/refresh?force=true`, {
                method: 'GET'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('刷新成功', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || '刷新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function refreshATInModal() {
        const teamId = document.getElementById('edit-team-id').value;
        if (!teamId) return;

        if (!confirm('确定要刷新此 Team 的 Access Token 吗?')) {
            return;
        }

        try {
            showToast('正在刷新...', 'info');
            const response = await fetch(`/api/teams/${teamId}/refresh?force=true`, {
                method: 'GET'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('刷新成功', 'success');

                // 刷新成功后，重新获取 Team 信息以更新模态框中的 AT
                const infoResponse = await fetch(`/admin/teams/${teamId}/info`);
                const infoData = await infoResponse.json();

                if (infoResponse.ok && infoData.success) {
                    const team = infoData.team;
                    document.getElementById('edit-team-token').value = team.access_token || '';
                    document.getElementById('edit-team-refresh-token').value = team.refresh_token || '';
                    document.getElementById('edit-team-session-token').value = team.session_token || '';
                    document.getElementById('edit-team-role').value = team.account_role || '未知';

                    // 重新创建图标以免刷新后丢失
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }
            } else {
                showToast(data.error || '刷新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function deleteTeam(teamId, email) {
        if (!confirm(`确定要删除 Team "${email}" 吗?\n\n此操作不可恢复!`)) {
            return;
        }

        try {
            showToast('正在删除...', 'info');
            const response = await fetch(`/admin/teams/${teamId}/delete`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('删除成功', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || '删除失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }
    async function editTeam(teamId) {
        try {
            const response = await fetch(`/admin/teams/${teamId}/info`);
            const data = await response.json();

            if (response.ok && data.success) {
                const team = data.team;
                document.getElementById('edit-team-id').value = team.id;
                document.getElementById('edit-team-email').value = team.email;
                document.getElementById('edit-team-token').value = team.access_token || '';
                document.getElementById('edit-team-refresh-token').value = team.refresh_token || '';
                document.getElementById('edit-team-session-token').value = team.session_token || '';
                document.getElementById('edit-team-client-id').value = team.client_id || '';
                document.getElementById('edit-team-account-id').value = team.account_id || '';
                document.getElementById('edit-team-max-members').value = team.max_members || 6;
                document.getElementById('edit-team-name').value = team.team_name || '';
                document.getElementById('edit-team-status').value = team.status || 'active';
                document.getElementById('edit-team-role').value = team.account_role || '未知';
                showModal('editTeamModal');
            } else {
                showToast(data.error || '获取信息失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function handleEditTeam(event) {
        event.preventDefault();
        const teamId = document.getElementById('edit-team-id').value;
        const payload = {
            email: document.getElementById('edit-team-email').value,
            access_token: document.getElementById('edit-team-token').value,
            refresh_token: document.getElementById('edit-team-refresh-token').value,
            session_token: document.getElementById('edit-team-session-token').value,
            client_id: document.getElementById('edit-team-client-id').value,
            account_id: document.getElementById('edit-team-account-id').value,
            max_members: parseInt(document.getElementById('edit-team-max-members').value),
            team_name: document.getElementById('edit-team-name').value,
            status: document.getElementById('edit-team-status').value
        };

        try {
            const response = await fetch(`/admin/teams/${teamId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('更新成功', 'success');
                hideModal('editTeamModal');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || '更新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    // Column Toggler Logic
    function initColumnToggler(tableSelector, storageKey) {
        const table = document.querySelector(tableSelector);
        if (!table) return;

        const headers = table.querySelectorAll('thead th');
        const container = document.getElementById('columnToggleDropdown');
        if (!container) return;

        container.innerHTML = '<div class="dropdown-header">显示/隐藏列</div>';

        // Load saved preferences
        const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');

        headers.forEach((th, index) => {
            const text = th.innerText.trim();
            if (!text || text === '操作' || th.querySelector('input')) return; // Checkbox column or Action

            const isVisible = !saved.includes(index);
            if (!isVisible) {
                th.style.display = 'none';
                table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`).forEach(td => td.style.display = 'none');
            }

            const item = document.createElement('label');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <input type="checkbox" ${isVisible ? 'checked' : ''}>
                <span>${text}</span>
            `;

            item.querySelector('input').addEventListener('change', (e) => {
                const checked = e.target.checked;
                // Toggle header
                th.style.display = checked ? '' : 'none';
                // Toggle cells
                table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`).forEach(td => td.style.display = checked ? '' : 'none');

                // Save to localStorage
                const currentSaved = JSON.parse(localStorage.getItem(storageKey) || '[]');
                if (checked) {
                    const idx = currentSaved.indexOf(index);
                    if (idx > -1) currentSaved.splice(idx, 1);
                } else {
                    if (!currentSaved.includes(index)) currentSaved.push(index);
                }
                localStorage.setItem(storageKey, JSON.stringify(currentSaved));
            });

            container.appendChild(item);
        });
    }

    function toggleDropdown(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.toggle('show');
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if (d.id !== id) d.classList.remove('show');
            });
        }
    }

    // Close dropdowns
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown-wrapper') && !e.target.closest('.dropdown-toggle')) {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
        }
    });

    function changePerPage(val) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', val);
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }
</script>
{% endblock %}
