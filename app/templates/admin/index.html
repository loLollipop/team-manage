{% extends "base.html" %}

{% block title %}æ§åˆ¶å° - GPT Team ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h2>æ§åˆ¶å°</h2>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_teams }}</div>
            <div class="stat-label">Team æ€»æ•°</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.available_teams }}</div>
            <div class="stat-label">å¯ç”¨ Team</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon">ğŸ«</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_codes }}</div>
            <div class="stat-label">å…‘æ¢ç æ€»æ•°</div>
        </div>
    </div>
    <div class="stat-card stat-warning">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.used_codes }}</div>
            <div class="stat-label">å·²ä½¿ç”¨å…‘æ¢ç </div>
        </div>
    </div>
</div>

<!-- Team åˆ—è¡¨ -->
<div class="content-section">
    <div class="section-header">
        <h3>Team åˆ—è¡¨</h3>
        <button onclick="showModal('importTeamModal')" class="btn btn-primary">å¯¼å…¥ Team</button>
    </div>

    {% if teams %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>é‚®ç®±</th>
                    <th>Team åç§°</th>
                    <th>æˆå‘˜æ•°</th>
                    <th>è®¢é˜…è®¡åˆ’</th>
                    <th>åˆ°æœŸæ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr>
                    <td>{{ team.email }}</td>
                    <td>{{ team.team_name or '-' }}</td>
                    <td>
                        <span class="member-count">
                            {{ team.current_members }}/{{ team.max_members }}
                        </span>
                    </td>
                    <td>{{ team.subscription_plan or '-' }}</td>
                    <td>
                        {% if team.expires_at %}
                        {{ team.expires_at|format_datetime }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ team.status }}">
                            {% if team.status == 'active' %}
                            å¯ç”¨
                            {% elif team.status == 'full' %}
                            å·²æ»¡
                            {% elif team.status == 'expired' %}
                            å·²è¿‡æœŸ
                            {% else %}
                            å¼‚å¸¸
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="viewMembers({{ team.id }})" class="btn btn-sm btn-info" title="æŸ¥çœ‹æˆå‘˜">
                                æˆå‘˜
                            </button>
                            <button onclick="refreshTeam({{ team.id }})" class="btn btn-sm btn-secondary" title="åˆ·æ–°">
                                åˆ·æ–°
                            </button>
                            <button onclick="deleteTeam({{ team.id }}, '{{ team.email }}')"
                                class="btn btn-sm btn-danger" title="åˆ é™¤">
                                åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ—  Team æ•°æ®</p>
        <button onclick="showModal('importTeamModal')" class="btn btn-primary">ç«‹å³å¯¼å…¥</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function viewMembers(teamId) {
        window.location.href = `/admin/teams/${teamId}/members`;
    }

    async function refreshTeam(teamId) {
        if (!confirm('ç¡®å®šè¦åˆ·æ–°æ­¤ Team çš„ä¿¡æ¯å—?')) {
            return;
        }

        try {
            showToast('æ­£åœ¨åˆ·æ–°...', 'info');
            const response = await fetch(`/api/teams/${teamId}/refresh`, {
                method: 'GET'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('åˆ·æ–°æˆåŠŸ', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'åˆ·æ–°å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    async function deleteTeam(teamId, email) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ Team "${email}" å—?\n\næ­¤æ“ä½œä¸å¯æ¢å¤!`)) {
            return;
        }

        try {
            showToast('æ­£åœ¨åˆ é™¤...', 'info');
            const response = await fetch(`/admin/teams/${teamId}/delete`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }
</script>
{% endblock %}