{% extends "base.html" %}

{% block title %}系统设置 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>系统设置</h2>
</div>

<!-- 代理配置 -->
<div class="content-section">
    <div class="section-header">
        <h3>代理配置</h3>
    </div>

    <form id="proxyForm" class="settings-form">
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="proxyEnabled" name="enabled" {% if proxy_enabled %}checked{% endif %}>
                <span>启用代理</span>
            </label>
            <p class="form-help">启用后,所有ChatGPT API请求将通过代理服务器</p>
        </div>

        <div class="form-group">
            <label for="proxyUrl">代理地址</label>
            <input type="text" id="proxyUrl" name="proxy" value="{{ proxy or '' }}"
                placeholder="http://127.0.0.1:7890, socks5://127.0.0.1:1080 或 socks5h://127.0.0.1:1080"
                class="form-control">
            <p class="form-help">支持HTTP、SOCKS5和SOCKS5H (远程DNS解析) 代理</p>
        </div>

        <button type="submit" class="btn btn-primary">保存代理配置</button>
    </form>
</div>

<!-- 密码修改 -->
<div class="content-section">
    <div class="section-header">
        <h3>修改密码</h3>
    </div>

    <form id="passwordForm" class="settings-form">
        <div class="form-group">
            <label for="oldPassword">旧密码</label>
            <input type="password" id="oldPassword" name="old_password" required class="form-control"
                placeholder="请输入当前密码">
        </div>

        <div class="form-group">
            <label for="newPassword">新密码</label>
            <input type="password" id="newPassword" name="new_password" required minlength="6" class="form-control"
                placeholder="请输入新密码(至少6位)">
        </div>

        <div class="form-group">
            <label for="confirmPassword">确认新密码</label>
            <input type="password" id="confirmPassword" name="confirm_password" required minlength="6"
                class="form-control" placeholder="请再次输入新密码">
        </div>

        <button type="submit" class="btn btn-primary">修改密码</button>
        <p class="form-help">修改密码后需要重新登录</p>
    </form>
</div>

<!-- 日志级别 -->
<div class="content-section">
    <div class="section-header">
        <h3>日志级别</h3>
    </div>

    <form id="logLevelForm" class="settings-form">
        <div class="form-group">
            <label for="logLevel">日志级别</label>
            <select id="logLevel" name="level" class="form-control">
                <option value="DEBUG" {% if log_level=='DEBUG' %}selected{% endif %}>DEBUG - 调试信息</option>
                <option value="INFO" {% if log_level=='INFO' %}selected{% endif %}>INFO - 一般信息</option>
                <option value="WARNING" {% if log_level=='WARNING' %}selected{% endif %}>WARNING - 警告信息</option>
                <option value="ERROR" {% if log_level=='ERROR' %}selected{% endif %}>ERROR - 错误信息</option>
                <option value="CRITICAL" {% if log_level=='CRITICAL' %}selected{% endif %}>CRITICAL - 严重错误</option>
            </select>
            <p class="form-help">调整系统日志的详细程度,DEBUG级别会记录最详细的信息</p>
        </div>

        <button type="submit" class="btn btn-primary">保存日志级别</button>
    </form>
</div>

<div class="settings-section card">
    <div class="section-header">
        <h3>Token 自动刷新</h3>
    </div>

    <form id="tokenRefreshForm" class="settings-form">
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="tokenAutoRefreshEnabled" name="enabled" {% if token_auto_refresh_enabled %}checked{% endif %}>
                <span>启用后台自动刷新 Access Token</span>
            </label>
            <p class="form-help">启用后，系统会按设定间隔扫描并预刷新即将过期的 Token。</p>
        </div>

        <div class="form-group">
            <label for="tokenAutoRefreshInterval">检查间隔（秒）</label>
            <input type="number" id="tokenAutoRefreshInterval" name="interval_seconds" min="5" value="{{ token_auto_refresh_interval_seconds }}" class="form-control">
            <p class="form-help">最小 5 秒。建议设置为 30~120 秒。</p>
        </div>

        <div class="form-group">
            <label for="tokenRefreshLead">提前刷新窗口（秒）</label>
            <input type="number" id="tokenRefreshLead" name="lead_seconds" min="0" value="{{ token_refresh_lead_seconds }}" class="form-control">
            <p class="form-help">当 Token 剩余有效期小于该值时，将触发预刷新。默认 300 秒。</p>
        </div>

        <button type="submit" class="btn btn-primary">保存自动刷新配置</button>
    </form>
</div>



<div class="settings-section card">
    <div class="section-header">
        <h3>到期提醒邮件配置</h3>
    </div>

    <form id="reminderEmailForm" class="settings-form">
        <div class="form-group">
            <label for="reminderSendChannel">发送通道</label>
            <select id="reminderSendChannel" name="send_channel" class="form-control">
                <option value="smtp" {% if reminder_email_config.send_channel == 'smtp' %}selected{% endif %}>SMTP 邮箱</option>
                <option value="email_api" {% if reminder_email_config.send_channel == 'email_api' %}selected{% endif %}>邮箱 API</option>
            </select>
            <p class="form-help">如果你使用油猴脚本中的邮箱接口，建议选择“邮箱 API”。</p>
        </div>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="reminderAutoSendEnabled" name="auto_send_enabled" {% if reminder_email_config.auto_send_enabled %}checked{% endif %}>
                <span>开启自动发送（每日检查后自动发出）</span>
            </label>
        </div>

        <div class="form-group">
            <label for="reminderDueDays">提前提醒天数</label>
            <input type="number" id="reminderDueDays" name="due_days" class="form-control" min="0" max="30" value="{{ reminder_email_config.due_days }}">
        </div>

        <div class="form-group">
            <label for="reminderSubject">邮件主题</label>
            <input type="text" id="reminderSubject" name="subject" class="form-control" value="{{ reminder_email_config.subject }}">
        </div>

        <div class="form-group">
            <label for="reminderBody">邮件正文模板</label>
            <textarea id="reminderBody" name="body_template" class="form-control" rows="4">{{ reminder_email_config.body_template }}</textarea>
            <p class="form-help">可用变量：{email}、{expire_at}、{days_left}</p>
        </div>

        <h4 style="margin: 1rem 0 0.5rem;">SMTP 配置</h4>
        <div class="form-group"><label for="smtpHost">SMTP Host</label><input type="text" id="smtpHost" class="form-control" value="{{ reminder_email_config.smtp_host }}"></div>
        <div class="form-group"><label for="smtpPort">SMTP Port</label><input type="number" id="smtpPort" class="form-control" min="1" max="65535" value="{{ reminder_email_config.smtp_port }}"></div>
        <div class="form-group"><label for="smtpUser">SMTP 用户名</label><input type="text" id="smtpUser" class="form-control" value="{{ reminder_email_config.smtp_user }}"></div>
        <div class="form-group"><label for="smtpPassword">SMTP 密码</label><input type="password" id="smtpPassword" class="form-control" value="{{ reminder_email_config.smtp_password }}"></div>
        <div class="form-group"><label for="smtpFrom">发件人邮箱</label><input type="text" id="smtpFrom" class="form-control" value="{{ reminder_email_config.smtp_from }}"></div>

        <h4 style="margin: 1rem 0 0.5rem;">邮箱 API 配置（可对应你的油猴脚本）</h4>
        <div class="form-group"><label for="emailApiUrl">邮箱 API URL</label><input type="text" id="emailApiUrl" class="form-control" value="{{ reminder_email_config.email_api_url }}" placeholder="例如：https://xxx.onrender.com/api/send"></div>
        <div class="form-group"><label for="emailApiKey">邮箱 API Key</label><input type="password" id="emailApiKey" class="form-control" value="{{ reminder_email_config.email_api_key }}"></div>
        <div class="form-group"><label for="emailApiToken">邮箱 API Token</label><input type="password" id="emailApiToken" class="form-control" value="{{ reminder_email_config.email_api_token }}"></div>

        <button type="submit" class="btn btn-primary">保存提醒邮件配置</button>
    </form>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .form-help {
        font-size: 0.8125rem;
        color: var(--text-muted);
        margin-top: 0.375rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // 代理配置表单
    document.getElementById('proxyForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const enabled = document.getElementById('proxyEnabled').checked;
        const proxy = document.getElementById('proxyUrl').value.trim();

        // 验证
        if (enabled && !proxy) {
            showToast('请输入代理地址', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/settings/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled, proxy })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('代理配置已保存', 'success');
            } else {
                showToast(data.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });

    // 密码修改表单
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // 验证
        if (newPassword.length < 6) {
            showToast('新密码至少6位', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('两次输入的密码不一致', 'error');
            return;
        }

        try {
            const response = await fetch('/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('密码修改成功,即将跳转到登录页', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showToast(data.error || '修改失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });




    // 到期提醒邮件配置表单
    document.getElementById('reminderEmailForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
            send_channel: document.getElementById('reminderSendChannel').value,
            auto_send_enabled: document.getElementById('reminderAutoSendEnabled').checked,
            due_days: Number(document.getElementById('reminderDueDays').value || 3),
            subject: document.getElementById('reminderSubject').value.trim(),
            body_template: document.getElementById('reminderBody').value.trim(),
            smtp_host: document.getElementById('smtpHost').value.trim(),
            smtp_port: Number(document.getElementById('smtpPort').value || 587),
            smtp_user: document.getElementById('smtpUser').value.trim(),
            smtp_password: document.getElementById('smtpPassword').value,
            smtp_from: document.getElementById('smtpFrom').value.trim(),
            email_api_url: document.getElementById('emailApiUrl').value.trim(),
            email_api_key: document.getElementById('emailApiKey').value.trim(),
            email_api_token: document.getElementById('emailApiToken').value.trim()
        };

        if (payload.due_days < 0 || payload.due_days > 30) {
            showToast('提前提醒天数必须在 0-30 之间', 'error');
            return;
        }
        if (!payload.subject) {
            showToast('请填写邮件主题', 'error');
            return;
        }
        if (!payload.body_template) {
            showToast('请填写邮件正文', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/settings/reminder-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok && data.success) {
                showToast('提醒邮件配置已保存', 'success');
            } else {
                showToast(data.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });

    // Token 自动刷新配置表单
    document.getElementById('tokenRefreshForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const enabled = document.getElementById('tokenAutoRefreshEnabled').checked;
        const interval_seconds = Number(document.getElementById('tokenAutoRefreshInterval').value || 0);
        const lead_seconds = Number(document.getElementById('tokenRefreshLead').value || 0);

        if (interval_seconds < 5) {
            showToast('检查间隔不能小于5秒', 'error');
            return;
        }

        if (lead_seconds < 0) {
            showToast('提前刷新窗口不能小于0', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/settings/token-refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled, interval_seconds, lead_seconds })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('Token 自动刷新配置已保存', 'success');
            } else {
                showToast(data.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });

    // 日志级别表单
    document.getElementById('logLevelForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const level = document.getElementById('logLevel').value;

        try {
            const response = await fetch('/admin/settings/log-level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ level })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('日志级别已保存', 'success');
            } else {
                showToast(data.error || '保存失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });
</script>
{% endblock %}