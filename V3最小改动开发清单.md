# V3 方案最小改动开发清单

> 目标：在**不影响旧逻辑**的前提下，落地“按邮箱合并生命周期 + 旧账可补录 + 提醒可汇总”的 V3 规则。

## 0. 本期边界（先做什么，不做什么）

### 本期必须做
- 新增“邮箱生命周期主档 + 事件表 + 提醒队列表”。
- 兑换码加入、手动邀请成功后，统一写入生命周期事件。
- 手动邀请表单新增“旧账客户 + 剩余质保天数”输入。
- 每日自动检查（仅收集提醒候选，不自动群发）。
- 管理端新增“提醒汇总页”（一行一个邮箱 + 手动发送按钮）。

### 本期不做
- 不回填 2026-03-01 之前历史数据。
- 不改现有兑换码业务语义（仅新增追踪和提醒能力）。
- 不做复杂批量群发/模板中心（先支持手动逐条发送）。

---

## 1. 数据模型最小新增

## 1.1 `member_lifecycles`（邮箱主档，1邮箱1条）
字段建议：
- `id` PK
- `email` UNIQUE NOT NULL
- `first_joined_at` DATETIME NOT NULL
- `policy_type` TEXT NOT NULL  
  - 枚举：`warranty` / `manual_28d` / `redeem_no_warranty_28d`
- `policy_expires_at` DATETIME NULL
- `has_migration_downtime` BOOLEAN DEFAULT 0
- `is_legacy_seeded` BOOLEAN DEFAULT 0
- `effective_from` DATETIME NOT NULL（固定写入 `2026-03-01 00:00:00`）
- `current_team_id` INTEGER NULL
- `status` TEXT DEFAULT `active`
- `created_at` / `updated_at`

索引：
- `idx_lifecycle_email`（unique）
- `idx_lifecycle_policy_expires`（提醒扫描用）

## 1.2 `member_lifecycle_events`（事件流）
字段建议：
- `id` PK
- `lifecycle_id` FK -> member_lifecycles.id
- `event_type` TEXT NOT NULL  
  - `redeem_join` / `manual_join` / `migrate` / `team_banned` / `legacy_seed`
- `source_type` TEXT NOT NULL  
  - `redeem` / `manual`
- `code_or_manual_tag` TEXT NULL（手动时写 `MANUAL`）
- `has_warranty` BOOLEAN DEFAULT 0
- `warranty_expires_at` DATETIME NULL
- `from_team_id` INTEGER NULL
- `to_team_id` INTEGER NULL
- `event_at` DATETIME NOT NULL
- `meta_json` TEXT NULL

索引：
- `idx_lifecycle_event_time`（lifecycle_id, event_at）

## 1.3 `member_reminder_queue`（提醒候选）
字段建议：
- `id` PK
- `lifecycle_id` FK
- `email`
- `policy_type`
- `target_expires_at`
- `days_left`
- `reason`（如 `warranty_due` / `manual_28d_due` / `redeem_no_warranty_due`）
- `status` TEXT DEFAULT `pending`（`pending/sent/skipped`）
- `dedupe_key` TEXT UNIQUE（建议：`email + target_expires_at(date) + reason`）
- `last_sent_at` DATETIME NULL
- `last_send_result` TEXT NULL
- `created_at` / `updated_at`

---

## 2. 自动迁移最小改动

在 `app/models.py` 增加上述 3 个模型。

在 `app/db_migrations.py` 追加：
- 表不存在则创建（SQLite 可用 `CREATE TABLE IF NOT EXISTS`）。
- 新字段增量检查逻辑（避免老库启动失败）。
- 为 `member_lifecycles.email` 和 `member_reminder_queue.dedupe_key` 建唯一索引。

---

## 3. 写入链路改造（关键最小点）

## 3.1 兑换成功链路（已有）
位置：`app/services/redeem_flow.py` 成功后写 `RedemptionRecord` 的分支。
新增动作：
1. upsert `member_lifecycles(email)`：
   - 若不存在：`first_joined_at = redeemed_at`。
   - 若存在：保留原 `first_joined_at`。
2. 写 `member_lifecycle_events`：`event_type=redeem_join`。
3. 计算策略：
   - 有质保：`policy_type=warranty`, `policy_expires_at=warranty_expires_at`。
   - 无质保：`policy_type=redeem_no_warranty_28d`，`policy_expires_at=first_joined_at+28d`。

## 3.2 手动邀请链路（已有）
位置：`app/services/team.py::add_team_member` 成功后。
新增入参（见第4节）并写生命周期：
- 普通手动：`policy_type=manual_28d`，`policy_expires_at=first_joined_at+28d`。
- 勾选旧账客户 + 填了剩余质保：
  - `policy_type=warranty`
  - `policy_expires_at=now + remaining_warranty_days`
  - `is_legacy_seeded=1`
  - 事件：`event_type=legacy_seed`, `source_type=manual`

## 3.3 换空间/迁移事件
当同邮箱从旧 team 迁移到新 team 时，写 `event_type=migrate` 并标记：
- 对无质保策略：`has_migration_downtime=1`（后续检查直接跳过提醒）。

---

## 4. 手动添加成员接口与前端最小改动

## 4.1 后端请求模型
位置：`app/routes/admin.py::AddMemberRequest`
新增字段：
- `is_legacy_customer: bool = False`
- `legacy_remaining_warranty_days: Optional[int] = None`

校验规则：
- 若 `is_legacy_customer=true`，则 `legacy_remaining_warranty_days` 必填且范围 `0~365`。
- 否则忽略 `legacy_remaining_warranty_days`。

## 4.2 前端表单
位置：`app/templates/base.html` 成员管理弹窗。
新增：
- 复选框：`是否旧账客户`。
- 数字输入：`剩余质保天数`（默认隐藏，勾选后显示并必填）。

位置：`app/static/js/main.js::handleAddMember`
- 提交 JSON 扩展为：
  - `email`
  - `is_legacy_customer`
  - `legacy_remaining_warranty_days`

---

## 5. 每日检查任务（最小可用）

位置：`app/main.py` 生命周期后台任务区域。
新增一个 daily loop：
- 周期：24h（可复用设置服务后续再参数化）。
- 扫描条件：
  - `effective_from >= 2026-03-01`
  - `status=active`
- 规则：
  1. `policy_type=warranty`：按 `policy_expires_at` 判定临期（默认 <=3天）。
  2. `policy_type=manual_28d`：按 `policy_expires_at` 判定。
  3. `policy_type=redeem_no_warranty_28d`：
     - `has_migration_downtime=1` => 跳过。
     - 否则按 `policy_expires_at` 判定。
- 命中后 upsert `member_reminder_queue`（用 dedupe_key 防重复）。

---

## 6. 提醒汇总页（管理员）最小功能

新增页面：`/admin/reminders`

展示字段（每行一个邮箱）：
- 邮箱
- policy_type
- 首次加入时间
- 目标到期时间
- 剩余天数
- 当前 Team
- 标记（旧账/迁移/质保）
- 操作：`发送提醒`

发送按钮行为：
- 调用发送接口（先简化为系统邮件通道）。
- 成功后更新 queue：`status=sent`, `last_sent_at`, `last_send_result`。
- 同一 dedupe_key 当天重复点击直接提示“已发送”。

---

## 7. 文案与规则落地（防歧义）

在用户侧（或管理员说明）固定文案：
- “常规码（无质保）仅支持一次有效使用；若原空间封禁，不提供补位/换空间服务。”

---

## 8. 漏洞与防护清单（必须实现）

- 并发覆盖：邮箱主档 upsert，首次时间不可被后写覆盖。
- 参数污染：旧账勾选时强制校验剩余质保天数。
- 非法输入：剩余天数限定 `0~365`。
- 重复提醒：queue 用 dedupe_key 唯一约束。
- 规则越界：所有提醒查询必须硬过滤 `effective_from >= 2026-03-01`。
- 迁移漏记：迁移成功必须写 event，否则拒绝标记完成。

---

## 9. 验收用例（最小）

1. 手动普通邀请 -> 生成 lifecycle，policy=manual_28d。
2. 手动旧账邀请（剩余质保=10）-> policy=warranty，expires=now+10d。
3. 质保兑换成功 -> policy=warranty，expires=质保到期。
4. 无质保兑换成功 -> policy=redeem_no_warranty_28d。
5. 无质保用户发生迁移 -> `has_migration_downtime=1`，不进入提醒队列。
6. 到期前3天命中 -> reminders 页面出现该邮箱。
7. 点击发送提醒 -> queue 状态变 sent，重复点击被去重。

---

## 10. 实施顺序（建议）

1. 模型 + 迁移
2. 后端接口参数扩展 + 服务层写入生命周期
3. 前端手动邀请表单改造
4. 每日检查任务
5. 提醒汇总页 + 发送动作
6. 验收用例自测

> 以上即“V3 方案最小改动开发清单”。先保证规则闭环，再做批量发送、策略配置化等增强。
